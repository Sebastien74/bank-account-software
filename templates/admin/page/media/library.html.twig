{% extends "admin/base.html.twig" %}

{% trans_default_domain 'admin' %}

{% set websiteId = websiteId() %}
{% set pageIcon = 'fal photo-video' %}

{% block title %}{{ "Bibliothèque de médias"|trans|htmlEntities }}{% endblock %}
{% block pageTitle %}{{ "Bibliothèque de médias"|trans }}{% endblock %}

{% block stylesheets %}
    {{ parent() }}
    {{ encore_entry_link_tags('admin-medias-library', null, 'admin') }}
{% endblock %}

{% block javascripts %}
    {{ encore_entry_script_tags('admin-medias-library', null,  'admin') }}
    {{ parent() }}
{% endblock %}

{% block body %}

    <div id="media-library-page" class="position-relative">

        {% if 'edit'|moduleActive(configuration) %}
            <div class="row">
                <div class="col-md-4">
                    {{ render_esi(path('admin_folder_new', {website: websiteId})) }}
                </div>
                <div class="col-md-8 text-md-end">
{#                    {% if granted('ROLE_INTERNAL') %} #}
{#                        <span id="clear-thumbs-btn" data-url="{{ path('admin_thumbs_remove_cache_list', {website: websiteId}) }}" class="btn btn-outline-danger standard d-inline-flex align-items-center" data-toggle="preloader"> #}
{#                            {{ 'fal trash'|icon(17, 14, 'danger me-2') }}{{ "Supprimer les vignettes"|trans }} #}
{#                        </span> #}
{#                    {% endif %} #}
                    {% if granted('ROLE_AI') %}

                        {% set apiIntls = website.entity.api.custom.intls is defined ? website.entity.api.custom.intls : false %}
                        {% set siteId = false %}
                        {% for apiIntl in apiIntls %}
                            {% if apiIntl.locale == app.request.locale %}
                                {% set siteId = apiIntl.aiFelixSiteId %}
                            {% endif %}
                        {% endfor %}

                        <div class="d-inline-flex flex-column">
                            <div class="me-2 text-white btn py-2 ai-button btn-chatgpt px-3"
                                 data-api-run="
                                 {{ path('ai_api_run', {
                                     'tool': 4,
                                     'site': siteId,
                                 }) }}"
                                 data-felix-api="
                                {{ path('ai_api_run_get_medias', {
                                     'tool': 4,
                                     'site': siteId,
                                 }) }}">
                                <span class="ai-icon">{{ 'cms ai'|icon(null, null, null, [], '#ffffff') }}</span>
                                <span class="d-none spinner-grow spinner-grow-sm" role="status" aria-hidden="true"></span>
                                <span class="ms-1">{{ 'Générer les balises ALT'|trans|raw }}</span>
                            </div>
                            <div id="generate-alts-progress" class="progress mt-2 d-none" style="width: 212px;">
                                <div id="progress-bar" class="progress-bar progress-bar-striped bg-info"
                                     role="progressbar" aria-valuenow="0" aria-valuemin="0" aria-valuemax="100"></div>
                            </div>
                        </div>
                    {% endif %}
                    {% if granted('ROLE_INTERNAL') %}
                        <span id="reorder-medias-btn" class="btn btn-outline-info-darken standard cursor me-2"
                              data-path="{{ path('admin_medias_reorder', { website: websiteId }) }}">
                            {{ 'fad folders'|icon(17, 14, 'dark me-2') }}{{ "Ranger les médias"|trans|raw }}
                        </span>
                    {% endif %}
                    <button class="btn btn-success standard"
                            data-bs-toggle="collapse"
                            href="#collapseFormMedias"
                            aria-expanded="false"
                            aria-controls="collapseFormMedias">
                        {{ 'fal plus'|icon(11, 15, 'white me-1') }}{{ "Ajouter des medias"|trans }}</button>
                </div>
            </div>
            {{ render_esi(path('admin_medias_uploader', {website: websiteId})) }}
        {% endif %}

        {% if tooHeavyFiles is defined and tooHeavyFiles is not empty %}
            {% if not masterRequest().get('too_heavy_files') %}
                {% set tooHeavyLink = path('admin_medias_library', {website: website.id, too_heavy_files: true}) %}
                {% set tooHeavyMessageHelp = "Des images trop volumineuses auront un impact négatif sur les performances de votre site Internet. Le poid recommandé est de 200Ko maximum."|trans %}
                {% set tooHeavyMessage = tooHeavyFilesCount > 1 ? 'Vous avez %count% images (> %limit%) qui devraient être optimsées ! Poids total : %weight%. <a href="%link%" class="text-underline">Voir les fichiers</a><br>%help%'|trans({'%count%': tooHeavyFilesCount, '%weight%': tooHeavyFilesSize|formatBytes, '%limit%': fileSizeLimit, '%link%': tooHeavyLink, '%help%': tooHeavyMessageHelp})
                    : 'Vous avez 1 image (> %limit%) qui devrait être optimsée ! Poids %weight%. <a href="%link%" class="text-underline">Voir le fichier</a>'|trans({'%link%': tooHeavyLink, '%weight%': tooHeavyFilesSize|formatBytes, '%limit%': fileSizeLimit}) %}
                {% include 'admin/include/alert.html.twig' with {alert: "warning", display: "alert", size: "small", class: "mt-3", message: tooHeavyMessage, '%help%': tooHeavyMessageHelp} only %}
            {% else %}
                {% set backMediasLink = path('admin_medias_library', {website: website.id}) %}
                {% set tooHeavyMessageList = tooHeavyFilesCount > 1 ? 'Liste de vos %count% images (> %limit%) a optimiser ! Poids total : %weight%. <a href="%link%" class="text-underline">Retourner aux médias</a>'|trans({'%count%': tooHeavyFilesCount, '%weight%': tooHeavyFilesSize|formatBytes, '%limit%': fileSizeLimit, '%link%': backMediasLink})
                    : 'Votre images (> %limit%) a optimiser ! Poids %weight%. <a href="%link%" class="text-underline">Retourner aux médias</a>'|trans({'%link%': backMediasLink, '%weight%': tooHeavyFilesSize|formatBytes, '%limit%': fileSizeLimit}) %}
                {% include 'admin/include/alert.html.twig' with {alert: "warning", display: "alert", size: "small", class: "mt-3", message: tooHeavyMessageList} only %}
            {% endif %}
        {% endif %}

        <div id="ajax-reorder-wrap" class="d-none"></div>

        <div class="row mt-3">
            <div class="col-md-5">
                <h4 class="card-subtitle mb-4">
                    <div class="row">
                        <div class="col-md-6 my-auto">{{ 'fal folder-tree'|icon(16, 14, 'info-darken me-2') }}{{ "Dossiers"|trans }}</div>
                        <div class="col-md-6 text-end my-auto">
                            {% if 'delete'|moduleActive(configuration) %}
                                <button id="delete-pack-btn" class="btn btn-danger d-none"
                                        data-bs-toggle="tooltip" title="{{ "Supprimer"|trans|striptags }}">
                                    {{ 'fas trash'|icon(13, 13, 'white') }}
                                </button>
                            {% endif %}
                            {% set collapsedAdminTrees = configuration.entity.collapsedAdminTrees is defined
                                ? configuration.entity.collapsedAdminTrees : website().entity.configuration.collapsedAdminTrees %}
                            <span id="nestable-expand-all"
                                  class="btn btn-outline-info-lighten cursor me-2{% if not collapsedAdminTrees %} d-none{% endif %}"
                                  data-bs-toggle="tooltip" title="{{ "Dépiler"|trans|raw }}">
                                {{ 'fal arrow-alt-to-bottom'|icon(11, 14) }}
                            </span>
                            <span id="nestable-collapse-all"
                                  class="btn btn-info-lighten cursor me-2{% if collapsedAdminTrees %} d-none{% endif %}"
                                  data-bs-toggle="tooltip" title="{{ "Empiler"|trans|raw }}">
                                {{ 'fal arrow-alt-to-top'|icon(11, 14, 'white') }}
                            </span>
                            <a href="{{ path('admin_medias_library', {website: websiteId}) }}"
                               class="ajax-get-refresh btn btn-info"
                               data-target="#medias-results"
                               data-target-loader="#medias-preloader">
                                {{ 'fas eye'|icon(16, 14, 'white me-2') }}{{ "Racine"|trans|striptags }}
                            </a>
                        </div>
                    </div>
                </h4>
                {% include 'admin/core/include/nestable.html.twig' with {
                    history: history is defined ? history : false,
                    routenameInterface: "folder",
                    customTitle: 'Afficher les médias'|trans,
                    customIcon: 'icm-eye',
                    customClass: 'ajax-get-refresh',
                    customBtn: 'info',
                    targetLoader: '#medias-preloader',
                    targetAjax: '#medias-results',
                    customRoute: 'admin_medias_library',
                    customRole: 'ROLE_EDIT'
                } %}
            </div>
            <div class="col-md-7">
                <div id="medias-card" class="card scroll-to-response-ajax">
                    <div class="d-none">
                        {% include 'admin/include/stripe-preloader.html.twig' with {preloaderId: 'medias-preloader', full: true} only %}
                    </div>
                    <h4 class="card-header mb-0">
                        <div class="row">
                            <div class="col-md-6 my-auto d-flex align-items-center">
                                {{ 'fal photo-video'|icon(23, 18, 'info-darken me-2') }}{{ "Médias"|trans }}
                                <div id="media-management-buttons" class="d-none ms-3">
                                    {% if 'edit'|moduleActive(configuration) %}
                                        <button id="select-folder-btn"
                                                data-path="{{ path('admin_folder_select', {website: websiteId}) }}"
                                                class="btn btn-warning standard">
                                            <i class="icm-share-square"></i><span
                                                    class="hidden-xs ms-1">{{ "Déplacer"|trans }}</span>
                                        </button>
                                    {% endif %}
                                    {% if granted('ROLE_MEDIA_COMPRESS') %}
                                        <button id="media-compress-btn" class="btn btn-info standard">
                                            <i class="icm-compress-alt"></i><span
                                                    class="hidden-xs ms-1">{{ "Compresser"|trans }}</span>
                                        </button>
                                    {% endif %}
                                    {% if 'delete'|moduleActive(configuration) %}
                                        <button class="btn btn-danger sa-warning sa-warning-delete-medias standard">
                                            <i class="icm-trash"></i>
                                        </button>
                                    {% endif %}
                                </div>
                            </div>
                            <div class="col-md-6 text-end">
                                {{ render_esi(path('admin_folders_medias_search', { website: websiteId })) }}
                            </div>
                        </div>
                    </h4>
                    <div class="card-body pb-2">
                        {% include 'admin/page/media/medias-list.html.twig' %}
                    </div>
                </div>
            </div>
        </div>

    </div>

{% endblock %}
